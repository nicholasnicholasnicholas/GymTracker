@page "/nearest-gym"
@inject IJSRuntime JS
@rendermode InteractiveServer

<h1 class="mb-4 text-center">Map</h1>

<button id="blazorGetLocationBtn" class="btn btn-primary" @onclick="GetLocation" disabled="@isLoading">
    @if (isLoading)
    {
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
    <span class="sr-only"> Loading...</span>
    <span>&nbsp;Detecting...</span>
    }
    else
    {
        <span>Get My Location</span>
    }
</button>

<!-- locationMessage display removed -->
<!-- debugInfo removed -->

@if (nearestGyms?.Any() == true)
{
    <h5 class="mt-3">Nearby gyms</h5>
    <ul class="list-group">
        @foreach (var g in nearestGyms)
        {
            <li class="list-group-item d-flex justify-content-between align-items-start">
                <div>
                    <div class="fw-bold">@g.Name</div>
                    <div class="text-muted small">@g.Address</div>
                </div>
                <span class="badge bg-primary rounded-pill">@String.Format("{0:0.0} mi", g.DistanceMiles)</span>
            </li>
        }
    </ul>
}
else if (!string.IsNullOrEmpty(locationMessage) && !isLoading)
{
    <div class="mt-3 text-muted">No nearby gyms found. Click the button to detect your location.</div>
}

<!-- Fallback: attach a DOM click handler in case Blazor event wiring isn't active -->
<script>
    (function () {
        try {
            const btn = document.getElementById('blazorGetLocationBtn');
            const msgEl = document.getElementById('blazorLocationMessage');
            if (!btn) return;

            btn.addEventListener('click', function (e) {
                // If Blazor handled it, this will be harmless; otherwise this gives a fallback
                try {
                    if (msgEl) msgEl.textContent = 'Fallback: detecting location...';
                    window.getUserLocation().then(p => {
                        if (msgEl) msgEl.textContent = `Lat: ${p.Latitude}, Lng: ${p.Longitude}`;
                        console.log('Fallback: got position', p);

                        // If map helper is present, add a user marker and pan to it
                        try {
                            if (window.geolocationMap && typeof window.geolocationMap.addUserMarker === 'function') {
                                window.geolocationMap.addUserMarker('nearestGymMap', p.Latitude, p.Longitude, { pan: true });
                            }
                        } catch (mapErr) {
                            console.error('Fallback map update error', mapErr);
                        }

                    }).catch(err => {
                        if (msgEl) msgEl.textContent = 'Fallback error: ' + err;
                        console.error('Fallback error', err);
                    });
                }
                catch (err) {
                    console.error('Fallback click handler error', err);
                }
            });
        }
        catch (err) {
            console.error('Error installing fallback click handler', err);
        }
    })();
</script>

<div class="mt-3">
    <div id="nearestGymMap" style="height: 400px; width: 100%; border: 1px solid #ddd; border-radius:4px;"></div>
</div>

@code {
    private string? locationMessage = string.Empty;
    // debugInfo removed
    private bool isLoading = false;
    private bool isSearching = false;

    private async Task GetLocation()
    {
        // Immediate feedback so we know the Blazor click handler fired
        isLoading = true;
        locationMessage = "Blazor handler invoked...";
        await JS.InvokeVoidAsync("console.log", "Blazor: GetLocation handler invoked");
        StateHasChanged();

        try
        {
            // Call the global function exposed in wwwroot/geolocation.js
            // First call it as raw object to log the result for debugging
            var raw = await JS.InvokeAsync<object>("getUserLocation");
            await JS.InvokeVoidAsync("console.log", "Blazor: raw result", raw);

            // Then map to the typed object
            var pos = await JS.InvokeAsync<Geolocation>("getUserLocation");
            locationMessage = $"Lat: {pos.Latitude}, Lng: {pos.Longitude}";

            // Compute nearest gyms from this position
            await ComputeNearestGymsAsync(pos.Latitude, pos.Longitude);

            // Add a user marker and re-center the map if the helper is available
            try
            {
                // Pass color options to match app theme and request a bounce
                await JS.InvokeVoidAsync("geolocationMap.addUserMarker", "nearestGymMap", pos.Latitude, pos.Longitude, new { pan = true, zoom = 13, popup = "You are here", color = "var(--color-primary)", ringColor = "var(--color-primary-light)" });
            }
            catch (JSException) { /* ignore if map helper is not present */ }
        }
        catch (JSException jsex)
        {
            locationMessage = "JS error: " + jsex.Message + "\n" + jsex.StackTrace;
            await JS.InvokeVoidAsync("console.error", "Blazor JSException:", jsex.Message, jsex.StackTrace);
        }
        catch (Exception ex)
        {
            locationMessage = "Error: " + ex.Message + "\n" + ex.StackTrace;
            await JS.InvokeVoidAsync("console.error", "Blazor Exception:", ex.Message, ex.StackTrace);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    public class Geolocation
    {
        public double Latitude { get; set; }
        public double Longitude { get; set; }
    }

    // Simple in-memory gym dataset. Replace with API call or database as needed.
    private readonly List<Gym> gyms = new()
    {
        // Anaheim
        new Gym("24 Hour Fitness Anaheim West", 33.8328, -117.9536, "3200 W Lincoln Ave"),
        new Gym("Planet Fitness Anaheim", 33.8339, -117.9147, "2091 S State College Blvd"),
        new Gym("LA Fitness - Anaheim Hills", 33.8589, -117.7407, "4500 E La Palma Ave"),

        // Santa Ana
        new Gym("LA Fitness - Santa Ana", 33.7456, -117.8646, "3820 S Bristol St"),
        new Gym("24 Hour Fitness Santa Ana", 33.7328, -117.8369, "1400 N Grand Ave"),
        new Gym("Planet Fitness Santa Ana", 33.7547, -117.8679, "5030 W 1st St"),

        // Irvine
        new Gym("Life Time - Lakeshore Irvine", 33.6699, -117.8545, "18007 Von Karman Ave"),
        new Gym("Equinox Sports Club Orange County", 33.6796, -117.8553, "1980 Main St"),
        new Gym("24 Hour Fitness Irvine Marketplace", 33.7053, -117.7719, "13752 Jamboree Rd"),
        new Gym("LA Fitness - Irvine (Barranca)", 33.6757, -117.7600, "6400 Irvine Blvd"),

        // Costa Mesa / Newport Beach
        new Gym("Equinox Newport Beach (Fashion Island)", 33.6140, -117.8750, "19540 Jamboree Rd"),
        new Gym("24 Hour Fitness Costa Mesa", 33.6809, -117.9133, "589 Anton Blvd"),
        new Gym("Planet Fitness Costa Mesa", 33.6633, -117.9195, "2300 Harbor Blvd"),
        new Gym("Crunch Fitness Costa Mesa", 33.6650, -117.9151, "2831 Harbor Blvd"),
        new Gym("24 Hour Fitness Newport Beach", 33.6284, -117.9128, "230 Newport Center Dr"),

        // Huntington Beach / Fountain Valley
        new Gym("24 Hour Fitness Huntington Beach", 33.7084, -118.0055, "9051 Atlanta Ave"),
        new Gym("Crunch Fitness Huntington Beach", 33.7227, -118.0036, "5880 Warner Ave"),
        new Gym("LA Fitness - Fountain Valley", 33.7088, -117.9533, "18032 Brookhurst St"),
        new Gym("Planet Fitness Fountain Valley", 33.7081, -117.9549, "16065 Brookhurst St"),

        // Tustin / Orange
        new Gym("LA Fitness - Tustin", 33.7231, -117.7963, "2300 Park Ave"),
        new Gym("Planet Fitness Tustin", 33.7239, -117.7874, "2850 El Camino Real"),
        new Gym("LA Fitness - Orange", 33.8096, -117.8360, "1500 E Village Way"),
        new Gym("24 Hour Fitness Orange", 33.7993, -117.8185, "360 N Tustin St"),

        // Fullerton / Brea / Buena Park
        new Gym("24 Hour Fitness Fullerton", 33.8866, -117.8883, "1801 E Chapman Ave"),
        new Gym("Planet Fitness Fullerton", 33.8742, -117.9161, "123 S Euclid St"),
        new Gym("LA Fitness - Fullerton", 33.8776, -117.9190, "500 N Harbor Blvd"),
        new Gym("24 Hour Fitness Brea", 33.9267, -117.8878, "400 W Imperial Hwy"),
        new Gym("LA Fitness - Brea", 33.9199, -117.8883, "383 W Imperial Hwy"),
        new Gym("Crunch Fitness Buena Park", 33.8705, -117.9968, "8308 On the Mall"),

        // South County (Mission Viejo / Laguna Niguel / Aliso Viejo / Lake Forest / San Clemente)
        new Gym("LA Fitness - Mission Viejo", 33.5604, -117.6678, "27742 Crown Valley Pkwy"),
        new Gym("Life Time - Laguna Niguel", 33.5404, -117.6884, "25600 Rancho Niguel Rd"),
        new Gym("Renaissance ClubSport Aliso Viejo", 33.5758, -117.7258, "50 Enterprise"),
        new Gym("LA Fitness - Lake Forest", 33.6436, -117.6905, "23641 El Toro Rd"),
        new Gym("24 Hour Fitness San Clemente", 33.4306, -117.6135, "638 Camino De Los Mares"),
        new Gym("LA Fitness - San Clemente", 33.4382, -117.6195, "900 Avenida Pico")

    };

    private List<NearestGymResult> nearestGyms = new();

    private async Task ComputeNearestGymsAsync(double userLat, double userLng)
    {
        isSearching = true;
        StateHasChanged();

        await Task.Yield(); // allow UI to update

            nearestGyms = gyms
            .Select(g => new NearestGymResult
            {
                Name = g.Name,
                Address = g.Address,
                DistanceMiles = HaversineDistanceMiles(userLat, userLng, g.Latitude, g.Longitude)
            })
            .OrderBy(r => r.DistanceMiles)
            .ToList();

        isSearching = false;
        StateHasChanged();
    }

    private static double HaversineDistanceMiles(double lat1, double lon1, double lat2, double lon2)
    {
        // Compute distance in kilometers then convert to miles
        double R = 6371; // Earth radius in km
        double dLat = ToRadians(lat2 - lat1);
        double dLon = ToRadians(lon2 - lon1);
        double a = Math.Sin(dLat / 2) * Math.Sin(dLat / 2) +
                   Math.Cos(ToRadians(lat1)) * Math.Cos(ToRadians(lat2)) *
                   Math.Sin(dLon / 2) * Math.Sin(dLon / 2);
        double c = 2 * Math.Atan2(Math.Sqrt(a), Math.Sqrt(1 - a));
        double km = R * c;
        return km * 0.621371; // convert km to miles
    }

    private static double ToRadians(double angle) => (Math.PI / 180) * angle;

    private record Gym(string Name, double Latitude, double Longitude, string Address);

    private class NearestGymResult
    {
        public string Name { get; set; } = string.Empty;
        public string Address { get; set; } = string.Empty;
        public double DistanceMiles { get; set; }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Center map on Fullerton, CA (approx)
            var fullertonLat = 33.8703;
            var fullertonLng = -117.9243;
            try
            {
                await JS.InvokeVoidAsync("geolocationMap.initMap", "nearestGymMap", fullertonLat, fullertonLng, 13);

                // Add initial markers from our gyms list
                var markers = gyms.Select(g => new { name = g.Name, address = g.Address, latitude = g.Latitude, longitude = g.Longitude }).ToArray();
                await JS.InvokeVoidAsync("geolocationMap.addMarkers", "nearestGymMap", markers);
            }
            catch (JSException) { /* ignore if map script not available */ }
        }
    }

    // Keep the fallback click handler, but don't show availability checks on render
}
