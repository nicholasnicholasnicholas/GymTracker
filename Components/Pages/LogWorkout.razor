@page "/logworkout"
@rendermode InteractiveServer
@inject IJSRuntime JS

@using System.Timers

@using GymTracker.ViewModels
@using GymTracker.Models
@using GymTracker.Data
@using GymTracker.Services

@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject UserSessionService UserSessionService
@inject UserService UserService

<h1 class="mb-4 text-center">Journal</h1>

<!-- Date and Workout Stopwatch containers -->
<div class="container-fluid container-white px-0 rounded">
    <div class=" d-flex flex-wrap gap-3">
        <!-- Date -->
        <div class="p-3 flex-fill" style="min-width: 150px;">
            <label class="form-label fs-4"><strong>Date</strong></label>
            <div class="d-flex gap-2">
                <input class="form-control fs-5 container-date" type="date" @bind="workoutDate" @bind:after="OnDateChanged"/>

                <!-- Old debug save stuff
                <button class="btn btn-outline-primary" @onclick="LoadSessionFromServer">Load</button>
                <button class="btn btn-outline-success" @onclick="SaveSessionToServer">Save</button>
                -->
            </div>
        </div>

        <!-- Workout Stopwatch -->
        <div class="p-3 flex-fill" style="min-width: 150px;">
            <label class="form-label fs-4"><strong>Stopwatch</strong></label>

            <div class="d-flex gap-2 mb-1">
                <button class="@buttonType flex-fill d-flex justify-content-between align-items-center fs-5" @onclick="ToggleWorkout">
                    <div class="d-flex align-items-center gap-2 fs-5">
                        <span>@(isWorkoutActive ? "⏹" : "▶")</span>
                        <strong>@buttonText</strong>
                    </div>
                    <span class="ms-3">@formattedDuration</span>
                </button>

                <button class="btn button-success" @onclick="ResetWorkout" disabled="@isWorkoutActive">
                    ↺
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Code - Date -->
@code {
    private DateTime workoutDate = DateTime.Today;
}

<!-- Code - Stopwatch -->
@code {
    private string buttonText => isWorkoutActive ? "Stop" : "Start";
    private string buttonType => isWorkoutActive ? "btn button-danger" : "btn button-success";

    private bool isWorkoutActive = false;

    private TimeSpan workoutDuration = TimeSpan.Zero; // Accumulated time
    private Timer? workoutTimer;
    private DateTime lastStartTime;

    private TimeSpan DisplayDuration =>
        isWorkoutActive
            ? workoutDuration + (DateTime.Now - lastStartTime) // running
            : workoutDuration; // paused

    private string formattedDuration => DisplayDuration.ToString(@"hh\:mm\:ss");

    private void ToggleWorkout()
    {
        if (!isWorkoutActive)
        {
            // Resume workout
            isWorkoutActive = true;
            lastStartTime = DateTime.Now;

            workoutTimer = new Timer(1000);
            workoutTimer.Elapsed += UpdateWorkoutDuration;
            workoutTimer.AutoReset = true;
            workoutTimer.Start();
        }
        else
        {
            // Pause workout
            isWorkoutActive = false;

            // Add the time since last resume
            workoutDuration += DateTime.Now - lastStartTime;

            workoutTimer?.Stop();
            workoutTimer?.Dispose();
            
            // Save the duration to the session and auto-save
            if (currentSession != null)
            {
                currentSession.Duration = workoutDuration.TotalSeconds;
                ScheduleAutoSave();
            }
        }
    }

    private void OnSetWeightChanged(Set set, ChangeEventArgs e)
    {
        var s = Convert.ToString(e.Value);
        if (double.TryParse(s, out var val))
        {
            set.Weight = val;
        }
        ScheduleAutoSave();
    }

    private void OnSetRepsChanged(Set set, ChangeEventArgs e)
    {
        var s = Convert.ToString(e.Value);
        if (int.TryParse(s, out var val))
        {
            set.Reps = val;
        }
        ScheduleAutoSave();
    }

    private void UpdateWorkoutDuration(object? sender, ElapsedEventArgs e)
    {
        InvokeAsync(StateHasChanged); // Just refresh UI
    }

    private void ResetWorkout()
    {
        if (isWorkoutActive)
            return;

        workoutDuration = TimeSpan.Zero;
    }
}


<!-- Journal NEW --> 
<div class="container-fluid container-white px-3 py-3 mt-3 rounded">
    <label class="form-label fs-4"><strong>Journal</strong></label>

    @*Is there a current session?*@
    @if (currentSession != null) {
        @*Show each workout entry*@
            @for (int i = 0; i < currentSession.WorkoutEntries.Count; i++) {   
            var currentEntry = currentSession.WorkoutEntries[i];
            var currentIndex = i;
            var isCollapsed = currentEntry.IsCollapsed;

            @*Exercise card*@
            <div class="exercise-card mb-2" @key="currentEntry.IdClient">
                <div class="exercise-card-header">
                    @*Caret*@
                    <button class="btn caret" @onclick="() => CollapseExercise(currentEntry)">
                        @(isCollapsed ? "►" : "▼")
                    </button>

                    @*Exercise name*@
                    <strong>@currentEntry.ExerciseName</strong>

                    @*Remove exercise button*@
                    <button type="button" 
                        class="btn exercise-remove ms-auto"
                        @onclick="() => RemoveExercise(currentEntry)">
                    ×
                    </button>
                </div>

                @*Exercise Sets*@
                <div id="exercise-body-@currentEntry.IdClient" class="exercise-card-body @(isCollapsed ? "hidden" : "")">
                    @for (int j = 0; j < currentEntry.Sets.Count; j++) {
                        var set = currentEntry.Sets[j];
                        var currentJndex = j; 
                        
                        <div @key="set" class="row g-1 exercise-card-set">
                            @*Set*@
                            <div class="col-4 exercise-card-set-label">
                                @*Remove Button*@
                                <button type="button" 
                                    class="btn set-remove" 
                                    @onclick="() => RemoveSet(currentEntry, currentJndex)"
                                    disabled="@(currentEntry.Sets.Count <= 1)">
                                    ×
                                    </button>

                                @*Label*@
                                Set @(j+1)
                            </div>

                            @*Weight*@
                            <div class="col-4 set">
                                <div class="input-wrapper">
                                    <input type="number" class="form-control form-control" placeholder="0" value="@set.Weight" @oninput="@(e => OnSetWeightChanged(set, e))" />
                                    <span class="input-group-text">lbs</span>
                                </div>
                            </div>

                            @*Reps*@
                            <div class="col-4 set">
                                <div class="input-wrapper">
                                    <input type="number" class="form-control" placeholder="0" value="@set.Reps" @oninput="@(e => OnSetRepsChanged(set, e))" />
                                    <span class="input-group-text">Reps</span>
                                </div>
                            </div>
                        </div>
                    }

                    @*Add Set*@
                    <div class="d-flex gap-2">
                        <button type="button" class="btn add-set d-flex align-items-center gap-2 fs-5 w-100" @onclick="() => AddSet(currentEntry)">
                            <span>+</span>
                            <strong>Add Set</strong>
                        </button>
                    </div>
                </div>
            </div>  
        }

        <!-- Add excercise -->
        <div class="d-flex gap-2">
            <select class="form-select add-exercise" @bind="newExerciseName" @bind:after="AddExercise">
                <option value="" disabled selected>
                    <div class="d-flex align-items-center gap-2 fs-5">
                        <span>+</span>
                        <strong>Add Exercise</strong>
                    </div>
                </option>
                <optgroup label="Chest">
                    @foreach (var exercise in ExerciseLibrary.Exercises.Where(e => e.MusclesWorked.ContainsKey("Upper Chest") || e.MusclesWorked.ContainsKey("Lower Chest")))
                    {
                        <option value="@exercise.Name">@exercise.Name</option>
                    }
                </optgroup>
                <optgroup label="Back">
                    @foreach (var exercise in ExerciseLibrary.Exercises.Where(e => e.MusclesWorked.ContainsKey("Upper Back")))
                    {
                        <option value="@exercise.Name">@exercise.Name</option>
                    }
                </optgroup>
                <optgroup label="Legs">
                    @foreach (var exercise in ExerciseLibrary.Exercises.Where(e => e.MusclesWorked.ContainsKey("Quads") || e.MusclesWorked.ContainsKey("Hamstrings") || e.MusclesWorked.ContainsKey("Glutes") || e.MusclesWorked.ContainsKey("Calves")))
                    {
                        <option value="@exercise.Name">@exercise.Name</option>
                    }
                </optgroup>
                <optgroup label="Arms">
                    @foreach (var exercise in ExerciseLibrary.Exercises.Where(e => e.MusclesWorked.ContainsKey("Biceps") || e.MusclesWorked.ContainsKey("Triceps")))
                    {
                        <option value="@exercise.Name">@exercise.Name</option>
                    }
                </optgroup>
                <optgroup label="Shoulders">
                    @foreach (var exercise in ExerciseLibrary.Exercises.Where(e => e.MusclesWorked.ContainsKey("Shoulders")))
                    {
                        <option value="@exercise.Name">@exercise.Name</option>
                    }
                </optgroup>
                <optgroup label="Core">
                    @foreach (var exercise in ExerciseLibrary.Exercises.Where(e => e.MusclesWorked.ContainsKey("Abs")))
                    {
                        <option value="@exercise.Name">@exercise.Name</option>
                    }
                </optgroup>
            </select>
        </div>
    }
    else {
        <p>Loading workout session...</p>
    }
</div>

@code {
    private WorkoutSession? currentSession;

    //Add a new exercise
    private string? newExerciseName;

    private void AddExercise()
    {
        if (string.IsNullOrWhiteSpace(newExerciseName)) return;

        currentSession ??= new WorkoutSession { Date = workoutDate };

        currentSession.WorkoutEntries.Add(
            new WorkoutEntry 
            {
                ExerciseName = newExerciseName,
                Sets = new List<Set> { new Set() }
            }
        );

        newExerciseName = "";
        ScheduleAutoSave();
    }

    private void RemoveExercise(WorkoutEntry entryToRemove)
    {
        if (currentSession == null || entryToRemove == null)
            return;

        currentSession.WorkoutEntries.Remove(entryToRemove);
        ScheduleAutoSave();
    }

    // Hide/Show Exercise (use element IDs + JS helpers instead of ElementReference capture)
    private bool _hasRendered = false;

    private async Task CollapseExercise(WorkoutEntry entryToCollapse)
    {
        entryToCollapse.IsCollapsed = !entryToCollapse.IsCollapsed;

          await FixMaxHeightById(entryToCollapse.IdClient, !entryToCollapse.IsCollapsed, 0);
        await FixMaxHeightById(entryToCollapse.IdClient, !entryToCollapse.IsCollapsed, 0);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!_hasRendered)
        {
            _hasRendered = true;

            // Automatically load the session for the selected date when the page first renders
            await LoadSessionFromServer();
        }
    }

    private async Task FixMaxHeightById(Guid id, bool show, int offset)
    {
        var elementId = $"exercise-body-{id}";
        var height = await JS.InvokeAsync<int>("getScrollHeightById", elementId);

        if (show)
        {
            await JS.InvokeVoidAsync("setMaxHeightById", elementId, height + 8 + offset);
        }
        else
        {
            await JS.InvokeVoidAsync("setMaxHeightById", elementId, 0);
        }
    }

    // Add set to exercise — recalc height after DOM updates
    private async Task AddSet(WorkoutEntry currentEntry)
    {
        currentEntry.Sets.Add(new Set());

        // Ensure the render happens so the new element is present in the DOM
        await InvokeAsync(StateHasChanged);
        await Task.Yield();

        // Recompute max-height for this entry so the collapse container fits
        await FixMaxHeightById(currentEntry.IdClient, !currentEntry.IsCollapsed, 0);
        ScheduleAutoSave();
    }

    // Remove set from exercise — recalc height after DOM updates
    private async Task RemoveSet(WorkoutEntry currentEntry, int index)
    {
        if (index >= 0 && index < currentEntry.Sets.Count)
        {
            currentEntry.Sets.RemoveAt(index);

            // Update the UI and then recompute height
            await InvokeAsync(StateHasChanged);
            await Task.Yield();

            await FixMaxHeightById(currentEntry.IdClient, !currentEntry.IsCollapsed, 0);
            ScheduleAutoSave();
        }
    }

    // --- Auto-save support (debounced) ---
    private System.Timers.Timer? _autoSaveTimer;
    private readonly int _autoSaveIntervalMs = 2000; // 2s debounce
    private bool _autoSavePending = false;

    private void ScheduleAutoSave()
    {
        try
        {
            if (_autoSaveTimer == null)
            {
                _autoSaveTimer = new System.Timers.Timer(_autoSaveIntervalMs);
                _autoSaveTimer.AutoReset = false;
                _autoSaveTimer.Elapsed += async (s, e) =>
                {
                    // Ensure we're on the renderer thread
                    await InvokeAsync(async () =>
                    {
                        await SaveSessionToServer();
                        _autoSavePending = false;
                    });
                };
            }

            _autoSavePending = true;
            _autoSaveTimer.Stop();
            _autoSaveTimer.Interval = _autoSaveIntervalMs;
            _autoSaveTimer.Start();
        }
        catch
        {
            // swallow - scheduling auto-save should not crash the UI
        }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            if (_autoSaveTimer != null)
            {
                _autoSaveTimer.Stop();
            }

            workoutTimer?.Stop();
            workoutTimer?.Dispose();

            if (_autoSavePending)
            {
                await SaveSessionToServer();
            }

            _autoSaveTimer?.Dispose();
        }
        catch
        {
            // ignore
        }
    }

    // Load a workout session on date changed
    private async Task OnDateChanged()
    {
        // Try to load a server-side session for the selected date if user is logged in.
        if (UserSessionService.IsLoggedIn)
        {
            await LoadSessionFromServer();
        }
        else
        {
            // Fallback to a new session placeholder when not logged in
            currentSession = new WorkoutSession { Date = workoutDate };
        }
    }

    private async Task LoadSessionFromServer()
    {
        if (!UserSessionService.IsLoggedIn)
        {
            // Not logged in — create a blank session for the date
            currentSession = new WorkoutSession { Date = workoutDate };
            await InvokeAsync(StateHasChanged);
            return;
        }

        var username = UserSessionService.Username;
        var session = await UserService.GetWorkoutSessionByDateAsync(username, workoutDate);

        if (session == null)
        {
            // No saved session for the date — create a fresh one
            currentSession = new WorkoutSession { Date = workoutDate };
        }
        else
        {
            currentSession = session;
            workoutDuration = TimeSpan.FromSeconds(session.Duration);
        }

        // Allow the component to render the loaded entries, then fix heights
        await InvokeAsync(StateHasChanged);
        await Task.Yield();

        if (currentSession != null)
        {
            foreach (var entry in currentSession.WorkoutEntries)
            {
                await FixMaxHeightById(entry.IdClient, !entry.IsCollapsed, 0);
            }
        }
    }

    private async Task SaveSessionToServer()
    {
        if (currentSession == null) return;

        if (!UserSessionService.IsLoggedIn)
        {
            // If not logged in, we could save to LocalStorage — for demo, just log
            var key = $"workout_{workoutDate:yyyyMMdd}";
            await LocalStorage.SetItemAsync(key, currentSession);
            Console.WriteLine($"Saved session to LocalStorage for {workoutDate:d}");
            return;
        }

        var username = UserSessionService.Username;
        var ok = await UserService.SaveWorkoutSessionAsync(username, currentSession);
        if (ok)
            Console.WriteLine($"Saved session for {username} on {workoutDate:d}");
        else
            Console.WriteLine("Failed to save session (user missing?)");
    }
}

<div class="container-fluid container-white px-3 py-3 mt-3 rounded">
    <label class="form-label fs-4"><strong>Summary</strong></label>
    <!-- View Summary Button -->
    <button class="view-summary w-100" @onclick="OpenPopup">
        <div class="d-flex align-items-center gap-2 fs-5">
            <span>☰</span>
            <strong>View Summary</strong>
        </div>
    </button>

    @if (showPopup)
    {
        <div class="overlay summary-overlay">
            <div class="overlay-content p-3">
                <button class="btn float-end" @onclick="ClosePopup">×</button>
                <label class="form-label fs-4"><strong>Summary</strong></label>
                
                @if (currentSession != null && currentSession.WorkoutEntries.Count > 0)
                {
                    <div class="summary-body mb-2">
                        <div class="col-12">
                            <strong>Duration:</strong> @formattedDuration
                        </div>
                    </div>

                    <div class="summary-body mb-3">
                        @{
                            var muscleStats = GetMusclePercentages();
                        }
                        <div class="summary-grid">
                            <div class="summary-left">  
                                <div class="muscle-heatmap-container">
                                    <img src="/bodyheatmap/Body.png" class="muscle-heatmap-base" alt="Body">
                                    @foreach (var m in muscleStats)
                                    {
                                        var filename = System.Uri.EscapeDataString(m.Name + ".png");
                                        var opacity = m.PercentOfMax > 0 ? m.PercentOfMax / 100.0 : .5;
                                        var filterClass = m.PercentOfMax > 0 ? string.Empty : "muscle-grayscale";
                                        <img src="/bodyheatmap/@(filename)" class="muscle-heatmap-overlay @(filterClass)" style=@($"opacity: {opacity}") alt="@m.Name">
                                    }
                                </div>
                            </div>

                            <div class="summary-right">
                                @if (muscleStats.Count > 0)
                                {
                                    <div class="percent-list">
                                    @foreach (var m in muscleStats.OrderByDescending(x => x.Points))
                                    {
                                        @if (m.Points > 0)
                                        {
                                            <div class="mb-2">
                                                <div class="d-flex justify-content-between align-items-center mb-1" style="font-size: 0.9rem;">
                                                    <div><strong>@m.Name</strong></div>
                                                    <div><small class="text" style="color: var(--color-dark); font-size: 0.8rem;">@m.Percent%</small></div>
                                                </div>
                                                <div class="progress" style="height:8px">
                                                    <div class="progress-bar" role="progressbar" style=@($"width:{m.PercentOfMax}%") aria-valuenow="@(m.PercentOfMax)" aria-valuemin="0" aria-valuemax="100"></div>
                                                </div>
                                            </div>
                                        }
                                    }
                                    </div>
                                }
                                else
                                {
                                    <p class="text-muted">No exercises added yet</p>
                                }
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <p class="text-muted">No exercises added yet</p>
                }
            </div>
        </div>
    }
</div>


@code {
    private bool showPopup = false;

    private void OpenPopup()
    {
        showPopup = true;
    }

    private void ClosePopup()
    {
        showPopup = false;
    }

    // Calculate aggregated muscles worked from all exercises in the current session
    private Dictionary<string, int> GetMusclesSummary()
    {
        var musclesSummary = new Dictionary<string, int>();

        if (currentSession == null || currentSession.WorkoutEntries.Count == 0)
            return musclesSummary;

        foreach (var entry in currentSession.WorkoutEntries)
        {
            // Find the exercise in the library to get its muscle groups
            var exercise = ExerciseLibrary.Exercises.FirstOrDefault(e => e.Name == entry.ExerciseName);
            if (exercise != null)
            {
                foreach (var muscle in exercise.MusclesWorked)
                {
                    if (musclesSummary.ContainsKey(muscle.Key))
                    {
                        musclesSummary[muscle.Key] += muscle.Value;
                    }
                    else
                    {
                        musclesSummary[muscle.Key] = muscle.Value;
                    }
                }
            }
        }

        return musclesSummary;
    }

    // Returns a list of muscle stats: name, raw points, percentage of total points, and percentage scaled to the top muscle
    // Includes muscles that have zero points so they can be displayed in the heatmap as faint/grayscale overlays
    private List<(string Name, int Points, double Percent, double PercentOfMax)> GetMusclePercentages()
    {
        // Start with all known muscles from both the ExerciseLibrary and MuscleLibrary
        // (this ensures muscles listed in `MuscleLibrary` but not referenced by any exercise are included)
        var exerciseMuscles = ExerciseLibrary.Exercises
            .SelectMany(e => e.MusclesWorked.Keys)
            .Distinct(StringComparer.OrdinalIgnoreCase);

        var libraryMuscles = MuscleLibrary.Muscles ?? new List<string>();

        var allMuscles = exerciseMuscles
            .Union(libraryMuscles, StringComparer.OrdinalIgnoreCase)
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .ToList();

        var dict = allMuscles.ToDictionary(m => m, m => 0);

        // Aggregate points from current session entries into the dict
        if (currentSession != null) 
        {
            foreach (var entry in currentSession.WorkoutEntries)
            {
                var exercise = ExerciseLibrary.Exercises.FirstOrDefault(e => e.Name == entry.ExerciseName);
                if (exercise == null) continue;

                foreach (var muscle in exercise.MusclesWorked)
                {
                    if (dict.ContainsKey(muscle.Key))
                        dict[muscle.Key] += muscle.Value;
                    else
                        dict[muscle.Key] = muscle.Value; // fallback (shouldn't normally happen)
                }
            }
        }

        var total = dict.Values.Sum();
        var result = new List<(string Name, int Points, double Percent, double PercentOfMax)>();

        var maxPoints = dict.Values.Any() ? dict.Values.Max() : 0;

        foreach (var kv in dict.OrderByDescending(k => k.Value))
        {
            var pct = total > 0 ? Math.Round(100.0 * kv.Value / total, 1) : 0.0; // percent of total
            var pctMax = maxPoints > 0 ? Math.Round(100.0 * kv.Value / maxPoints, 1) : 0.0; // percent relative to top muscle
            result.Add((kv.Key, kv.Value, pct, pctMax));
        }

        return result;
    }
}
