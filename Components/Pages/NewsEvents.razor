@page "/newsevents"
@using GymTracker.Models
@using GymTracker.Services
@using GymTracker.Data
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext Db
@inject UserSessionService UserSessionService
@inject NavigationManager NavigationManager

<div class="page-background">
    <div class="content-container">

        <h1>Gym News & Events</h1>

        @if (isLoading)
        {
            <p>Loading events…</p>
        }
        else
        {
            <!-- UPCOMING EVENTS -->
            <h4 class="section-title">Upcoming Events</h4>
            @if (upcomingEvents.Count == 0)
            {
                <p class="text-muted">No upcoming events right now.</p>
            }
            else
            {
                <div class="event-grid">
                    @foreach (var item in upcomingEvents)
                    {
                        <div class="event-card @(item.Date < DateTime.Now ? "past" : "")">

                            <div class="event-date-badge">
                                <span class="day">@item.Date.Day</span>
                                <span class="month">@item.Date.ToString("MMM")</span>
                            </div>

                            <div class="event-info">
                                <div class="event-title-section">
                                    <h5>@item.Title</h5>
                                </div>
                                <p class="event-location">@item.Location</p>
                                <p class="event-description">@item.Description</p>
                                <a class="btn" href="@item.Link" target="_blank">More Info →</a>
                            </div>

                        </div>
                    }
                </div>
            }

            <!-- PAST EVENTS -->
            <h4 class="section-title">Past Events</h4>
            @if (pastEvents.Count == 0)
            {
                <p class="text-muted">No past events yet.</p>
            }
            else
            {
                <div class="event-grid">
                    @foreach (var item in pastEvents)
                    {
                        <div class="event-card past">

                            <div class="event-date-badge">
                                <span class="day">@item.Date.Day</span>
                                <span class="month">@item.Date.ToString("MMM")</span>
                            </div>

                            <div class="event-info">
                                <div class="event-title-section">
                                    <h5>@item.Title</h5>
                                </div>
                                <p class="event-location">@item.Location</p>
                                <p class="event-description">@item.Description</p>
                                <a class="btn" href="@item.Link" target="_blank">View Details →</a>
                            </div>

                        </div>
                    }
                </div>
            }
        }
    </div>
</div>

@code {
    private bool isLoading = true;
    private List<Event> upcomingEvents = new();
    private List<Event> pastEvents = new();

    protected override async Task OnInitializedAsync()
    {
        await UserSessionService.LoadUserSessionAsync();

        var events = await Db.Events.AsNoTracking().ToListAsync();
        var now = DateTime.Now;

        upcomingEvents = events
            .Where(e => e.Date >= now)
            .OrderBy(e => e.Date)
            .ToList();

        pastEvents = events
            .Where(e => e.Date < now)
            .OrderByDescending(e => e.Date)
            .ToList();

        isLoading = false;
    }

}

